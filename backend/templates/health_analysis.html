<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyze My Health - MedAssist</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{
            --primary:#2F80ED;--primary-dark:#1D6FD8;--bg:#F5F7FA;--white:#FFFFFF;
            --text:#1A1A1A;--text-gray:#666;--text-light:#8B8B8B;--border:#E0E0E0;
            --shadow:0 2px 8px rgba(0,0,0,.06);--radius:8px;
            --green:#22c55e;--yellow:#f59e0b;--red:#ef4444;
        }
        body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);line-height:1.6;display:flex;height:100vh;overflow:hidden}

        /* ---- SIDEBAR (same as dashboard) ---- */
        .sidebar{width:260px;background:var(--white);border-right:1px solid var(--border);display:flex;flex-direction:column;height:100vh;overflow-y:auto;flex-shrink:0}
        .sidebar-header{padding:1.5rem 1.25rem;border-bottom:1px solid var(--border)}
        .logo{display:flex;align-items:center;gap:12px;text-decoration:none}
        .logo-icon{width:36px;height:36px;background:var(--primary);border-radius:6px;display:flex;align-items:center;justify-content:center;color:var(--white);font-size:16px}
        .logo-text{font-size:1.2rem;font-weight:700;color:var(--text)}
        .sidebar-nav{flex:1;padding:1rem 0}
        .nav-section{margin-bottom:1.5rem}
        .nav-section-title{padding:0 1.25rem;font-size:.7rem;font-weight:600;color:var(--text-light);text-transform:uppercase;letter-spacing:.5px;margin-bottom:.5rem}
        .nav-item{display:flex;align-items:center;gap:12px;padding:.75rem 1.25rem;color:var(--text-gray);text-decoration:none;transition:all .2s;font-size:.9rem;font-weight:500;cursor:pointer}
        .nav-item:hover{background:rgba(47,128,237,.05);color:var(--primary)}
        .nav-item.active{background:rgba(47,128,237,.1);color:var(--primary);border-right:3px solid var(--primary)}
        .nav-item i{width:20px;font-size:16px}
        .sidebar-footer{padding:1rem 1.25rem;border-top:1px solid var(--border)}
        .user-profile{display:flex;align-items:center;gap:12px;padding:.75rem;background:var(--bg);border-radius:var(--radius);margin-bottom:.75rem}
        .user-avatar{width:40px;height:40px;background:linear-gradient(135deg,var(--primary),var(--primary-dark));border-radius:50%;display:flex;align-items:center;justify-content:center;color:var(--white);font-size:14px;font-weight:600;overflow:hidden}
        .user-avatar img{width:100%;height:100%;object-fit:cover}
        .user-details{flex:1;min-width:0}
        .user-name{font-size:.85rem;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .user-email{font-size:.75rem;color:var(--text-gray);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .btn-logout{width:100%;padding:.75rem;background:transparent;border:1px solid var(--border);border-radius:var(--radius);color:var(--text-gray);font-size:.85rem;font-weight:500;cursor:pointer;font-family:inherit;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:8px;text-decoration:none}
        .btn-logout:hover{border-color:#dc2626;color:#dc2626;background:rgba(220,38,38,.05)}

        /* ---- MAIN ---- */
        .main-content{flex:1;overflow-y:auto;height:100vh}
        .container{max-width:1100px;margin:0 auto;padding:2rem}
        .page-header{margin-bottom:2rem;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:1rem}
        .page-header-left h1{font-size:1.8rem;font-weight:600}
        .page-header-left p{color:var(--text-gray);font-size:.95rem}
        .btn{padding:.75rem 1.5rem;border:none;border-radius:var(--radius);font-size:.9rem;font-weight:600;cursor:pointer;font-family:inherit;display:inline-flex;align-items:center;gap:.5rem;text-decoration:none;transition:all .2s}
        .btn-primary{background:var(--primary);color:var(--white)}
        .btn-primary:hover{background:var(--primary-dark)}
        .btn-outline{background:transparent;color:var(--text-gray);border:1px solid var(--border)}
        .btn-outline:hover{border-color:var(--primary);color:var(--primary)}

        /* ---- LOADING / SCANNING ---- */
        .scan-container{text-align:center;padding:4rem 2rem}
        .scan-icon{width:100px;height:100px;margin:0 auto 1.5rem;position:relative}
        .scan-ring{width:100px;height:100px;border:4px solid rgba(47,128,237,.15);border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        .scan-ring-inner{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:2rem;color:var(--primary)}
        .scan-title{font-size:1.3rem;font-weight:600;margin-bottom:.5rem}
        .scan-subtitle{color:var(--text-gray);font-size:.95rem;margin-bottom:1.5rem}
        .scan-steps{display:flex;flex-direction:column;gap:.5rem;max-width:350px;margin:0 auto;text-align:left}
        .scan-step{display:flex;align-items:center;gap:.75rem;font-size:.85rem;color:var(--text-gray);transition:color .3s}
        .scan-step.active{color:var(--primary);font-weight:500}
        .scan-step.done{color:var(--green)}
        .scan-step i{width:18px;text-align:center}

        /* ---- ERROR STATE ---- */
        .error-container{text-align:center;padding:4rem 2rem}
        .error-container i{font-size:3rem;color:var(--red);margin-bottom:1rem}
        .error-container h2{margin-bottom:.5rem}
        .error-container p{color:var(--text-gray);margin-bottom:1.5rem}

        /* ---- RESULTS ---- */
        .results{display:none;animation:fadeIn .5s ease}
        @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:none}}

        /* Data sources bar */
        .data-sources{display:flex;gap:1rem;margin-bottom:2rem;flex-wrap:wrap}
        .data-chip{display:flex;align-items:center;gap:6px;padding:.5rem 1rem;background:var(--white);border:1px solid var(--border);border-radius:20px;font-size:.8rem;color:var(--text-gray);font-weight:500}
        .data-chip i{font-size:12px;color:var(--primary)}
        .data-chip .chip-count{background:rgba(47,128,237,.1);color:var(--primary);padding:1px 8px;border-radius:10px;font-size:.75rem;font-weight:600}

        /* Risk gauge */
        .risk-card{background:var(--white);border:1px solid var(--border);border-radius:var(--radius);padding:2rem;text-align:center;margin-bottom:2rem}
        .risk-gauge{position:relative;width:200px;height:110px;margin:0 auto 1.5rem;overflow:hidden}
        .risk-gauge svg{width:200px;height:110px}
        .gauge-bg{fill:none;stroke:#e5e7eb;stroke-width:18;stroke-linecap:round}
        .gauge-fill{fill:none;stroke-width:18;stroke-linecap:round;transition:stroke-dashoffset 1.5s ease,stroke .5s}
        .risk-score{position:absolute;bottom:0;left:50%;transform:translateX(-50%);font-size:2.2rem;font-weight:700}
        .risk-score small{display:block;font-size:.7rem;font-weight:400;color:var(--text-gray)}
        .risk-label{display:inline-block;padding:.4rem 1.2rem;border-radius:20px;font-size:.95rem;font-weight:600;margin-bottom:.75rem}
        .risk-label.low{background:rgba(34,197,94,.12);color:#16a34a}
        .risk-label.moderate{background:rgba(245,158,11,.12);color:#d97706}
        .risk-label.high{background:rgba(239,68,68,.12);color:#dc2626}
        .risk-summary{color:var(--text-gray);font-size:.95rem;max-width:600px;margin:0 auto;line-height:1.7}

        /* Two-column grid */
        .analysis-grid{display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;margin-bottom:2rem}
        @media(max-width:800px){.analysis-grid{grid-template-columns:1fr}}
        .card{background:var(--white);border:1px solid var(--border);border-radius:var(--radius);padding:1.5rem}
        .card-title{font-size:1.05rem;font-weight:600;margin-bottom:1rem;display:flex;align-items:center;gap:8px}
        .card-title i{color:var(--primary);font-size:14px}

        /* Risk factors list */
        .risk-factor{padding:.75rem 0;border-bottom:1px solid var(--border)}
        .risk-factor:last-child{border-bottom:none}
        .rf-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.25rem}
        .rf-title{font-weight:600;font-size:.9rem}
        .rf-severity{font-size:.7rem;font-weight:600;padding:2px 10px;border-radius:10px;text-transform:uppercase}
        .rf-severity.low{background:rgba(34,197,94,.1);color:#16a34a}
        .rf-severity.medium{background:rgba(245,158,11,.1);color:#d97706}
        .rf-severity.high{background:rgba(239,68,68,.1);color:#dc2626}
        .rf-detail{font-size:.85rem;color:var(--text-gray)}

        /* Recommendations */
        .rec-item{padding:.75rem 0;border-bottom:1px solid var(--border);display:flex;gap:1rem;align-items:flex-start}
        .rec-item:last-child{border-bottom:none}
        .rec-icon{width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:14px}
        .rec-icon.lifestyle{background:rgba(34,197,94,.1);color:#16a34a}
        .rec-icon.nutrition{background:rgba(245,158,11,.1);color:#d97706}
        .rec-icon.exercise{background:rgba(59,130,246,.1);color:#3b82f6}
        .rec-icon.medical{background:rgba(239,68,68,.1);color:#dc2626}
        .rec-icon.mental_health{background:rgba(168,85,247,.1);color:#a855f7}
        .rec-icon.sleep{background:rgba(99,102,241,.1);color:#6366f1}
        .rec-title{font-weight:600;font-size:.9rem;margin-bottom:.15rem}
        .rec-desc{font-size:.85rem;color:var(--text-gray);line-height:1.5}

        /* Positive factors */
        .positive-item{display:flex;align-items:center;gap:10px;padding:.6rem 0;font-size:.9rem;color:var(--text)}
        .positive-item i{color:var(--green);font-size:14px}

        /* Suggested actions */
        .action-btn{display:flex;align-items:center;gap:10px;padding:.85rem 1rem;border:1px solid var(--border);border-radius:var(--radius);margin-bottom:.75rem;text-decoration:none;color:var(--text);transition:all .2s;font-size:.9rem}
        .action-btn:hover{border-color:var(--primary);background:rgba(47,128,237,.03);color:var(--primary)}
        .action-btn i{color:var(--primary);font-size:16px;width:20px;text-align:center}
        .action-btn .arrow{margin-left:auto;color:var(--text-light);font-size:12px}

        /* Responsive sidebar */
        @media(max-width:968px){
            .sidebar{transform:translateX(-100%);transition:transform .3s}
            .sidebar.open{transform:translateX(0)}
        }
    </style>
</head>
<body>
    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <a href="/dashboard" class="logo">
                <div class="logo-icon"><i class="fas fa-heartbeat"></i></div>
                <div class="logo-text">MedAssist</div>
            </a>
        </div>
        <nav class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-section-title">Main</div>
                <a href="/dashboard" class="nav-item"><i class="fas fa-home"></i><span>Home</span></a>
                <a href="/chat" class="nav-item"><i class="fas fa-comment-medical"></i><span>Chat</span></a>
                <a href="/health-tracker" class="nav-item"><i class="fas fa-chart-line"></i><span>Health Tracker</span></a>
            </div>
            <div class="nav-section">
                <div class="nav-section-title">Intelligence</div>
                <a href="/analyze-health" class="nav-item active"><i class="fas fa-brain"></i><span>Analyze My Health</span></a>
            </div>
            <div class="nav-section">
                <div class="nav-section-title">Community</div>
                <a href="/community" class="nav-item"><i class="fas fa-users"></i><span>Community</span></a>
                <a href="/report-issue" class="nav-item"><i class="fas fa-bullhorn"></i><span>Report Issue</span></a>
            </div>
            <div class="nav-section">
                <div class="nav-section-title">Profile</div>
                <a href="/profile" class="nav-item"><i class="fas fa-user-circle"></i><span>My Account</span></a>
            </div>
        </nav>
        <div class="sidebar-footer">
            <div class="user-profile">
                <div class="user-avatar">
                    {% if user.profile_image_path %}
                    <img src="{{ user.profile_image_path }}" alt="Profile">
                    {% else %}
                    <i class="fas fa-user"></i>
                    {% endif %}
                </div>
                <div class="user-details">
                    <div class="user-name">{{ user.name }}</div>
                    <div class="user-email">{{ user.email }}</div>
                </div>
            </div>
            <a href="/logout" class="btn-logout"><i class="fas fa-sign-out-alt"></i><span>Sign out</span></a>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <div class="main-content">
        <div class="container">
            <div class="page-header">
                <div class="page-header-left">
                    <h1><i class="fas fa-brain" style="color:var(--primary);margin-right:8px"></i>Analyze My Health</h1>
                    <p>AI-powered comprehensive health analysis based on all your data</p>
                </div>
                <div>
                    <a href="/dashboard" class="btn btn-outline"><i class="fas fa-arrow-left"></i> Dashboard</a>
                    <button id="btnRerun" class="btn btn-primary" style="display:none" onclick="runAnalysis()"><i class="fas fa-redo"></i> Re-analyze</button>
                </div>
            </div>

            <!-- SCANNING STATE -->
            <div id="scanState" class="scan-container">
                <div class="scan-icon">
                    <div class="scan-ring"></div>
                    <i class="fas fa-heartbeat scan-ring-inner"></i>
                </div>
                <div class="scan-title">Analyzing Your Health Profile</div>
                <div class="scan-subtitle">Gathering data from all connected modulesâ€¦</div>
                <div class="scan-steps">
                    <div class="scan-step" id="step1"><i class="fas fa-circle-notch fa-spin"></i> Collecting health tracker data</div>
                    <div class="scan-step" id="step2"><i class="fas fa-circle"></i> Scanning chatbot conversations</div>
                    <div class="scan-step" id="step3"><i class="fas fa-circle"></i> Reviewing symptom reports</div>
                    <div class="scan-step" id="step4"><i class="fas fa-circle"></i> Running AI health analysis</div>
                </div>
            </div>

            <!-- ERROR STATE -->
            <div id="errorState" class="error-container" style="display:none">
                <i class="fas fa-exclamation-triangle"></i>
                <h2>Analysis Failed</h2>
                <p id="errorMsg">Something went wrong. Please try again.</p>
                <button class="btn btn-primary" onclick="runAnalysis()"><i class="fas fa-redo"></i> Try Again</button>
            </div>

            <!-- RESULTS -->
            <div id="results" class="results">
                <!-- Data sources -->
                <div class="data-sources" id="dataSources"></div>

                <!-- Risk gauge -->
                <div class="risk-card">
                    <div class="risk-gauge">
                        <svg viewBox="0 0 200 110">
                            <path class="gauge-bg" d="M 20 100 A 80 80 0 0 1 180 100"/>
                            <path id="gaugeFill" class="gauge-fill" d="M 20 100 A 80 80 0 0 1 180 100" stroke="var(--green)" stroke-dasharray="251.2" stroke-dashoffset="251.2"/>
                        </svg>
                        <div class="risk-score">
                            <span id="riskScoreNum">0</span>
                            <small>/ 100</small>
                        </div>
                    </div>
                    <div id="riskLabel" class="risk-label low">Low Risk</div>
                    <p id="riskSummary" class="risk-summary"></p>
                </div>

                <!-- Two-column grid -->
                <div class="analysis-grid">
                    <!-- Risk factors -->
                    <div class="card">
                        <div class="card-title"><i class="fas fa-exclamation-triangle"></i> Key Risk Factors</div>
                        <div id="riskFactors"></div>
                    </div>

                    <!-- Recommendations -->
                    <div class="card">
                        <div class="card-title"><i class="fas fa-lightbulb"></i> Recommendations</div>
                        <div id="recommendations"></div>
                    </div>

                    <!-- Positive factors -->
                    <div class="card">
                        <div class="card-title"><i class="fas fa-check-circle"></i> What You're Doing Well</div>
                        <div id="positiveFactors"></div>
                    </div>

                    <!-- Suggested actions -->
                    <div class="card">
                        <div class="card-title"><i class="fas fa-directions"></i> Suggested Next Steps</div>
                        <div id="suggestedActions"></div>
                    </div>
                </div>

                <p style="text-align:center;color:var(--text-light);font-size:.8rem;margin-top:1rem">
                    <i class="fas fa-info-circle"></i> This analysis is AI-generated and is NOT a medical diagnosis. Always consult a healthcare professional.
                </p>
            </div>
        </div>
    </div>

<script>
const recIcons = {
    lifestyle:     'fas fa-leaf',
    nutrition:     'fas fa-apple-alt',
    exercise:      'fas fa-running',
    medical:       'fas fa-stethoscope',
    mental_health: 'fas fa-brain',
    sleep:         'fas fa-moon'
};
const actionIcons = {
    '/chat':           'fas fa-comment-medical',
    '/health-tracker': 'fas fa-chart-line',
    '/report-issue':   'fas fa-bullhorn'
};

/* ---- Scanning step animator ---- */
function advanceStep(stepNum) {
    for (let i = 1; i <= 4; i++) {
        const el = document.getElementById('step' + i);
        if (i < stepNum) {
            el.className = 'scan-step done';
            el.querySelector('i').className = 'fas fa-check-circle';
        } else if (i === stepNum) {
            el.className = 'scan-step active';
            el.querySelector('i').className = 'fas fa-circle-notch fa-spin';
        } else {
            el.className = 'scan-step';
            el.querySelector('i').className = 'fas fa-circle';
        }
    }
}

/* ---- Gauge animation ---- */
function animateGauge(score, level) {
    const maxDash = 251.2;
    const offset = maxDash - (score / 100) * maxDash;
    const fill = document.getElementById('gaugeFill');
    const colors = { low: 'var(--green)', moderate: 'var(--yellow)', high: 'var(--red)' };
    fill.style.stroke = colors[level.toLowerCase()] || 'var(--green)';
    setTimeout(() => { fill.style.strokeDashoffset = offset; }, 100);

    // Animate number
    let current = 0;
    const target = score;
    const step = Math.ceil(target / 40);
    const interval = setInterval(() => {
        current += step;
        if (current >= target) { current = target; clearInterval(interval); }
        document.getElementById('riskScoreNum').textContent = current;
    }, 30);
}

/* ---- Render results ---- */
function renderResults(data) {
    const a = data.analysis;
    const s = data.data_summary;

    // Data source chips
    const chips = [
        { icon: 'fas fa-chart-line', label: 'Tracker Entries', count: s.tracker_entries },
        { icon: 'fas fa-comment-medical', label: 'Chat Messages', count: s.chat_messages },
        { icon: 'fas fa-notes-medical', label: 'Symptoms', count: s.symptoms_found },
        { icon: 'fas fa-person', label: 'Body Areas', count: s.body_parts },
        { icon: 'fas fa-bullhorn', label: 'Health Reports', count: s.health_reports }
    ];
    document.getElementById('dataSources').innerHTML = chips.map(c =>
        `<div class="data-chip"><i class="${c.icon}"></i>${c.label}<span class="chip-count">${c.count}</span></div>`
    ).join('');

    // Risk label
    const lvl = (a.risk_level || 'Low').toLowerCase();
    const labelEl = document.getElementById('riskLabel');
    labelEl.className = 'risk-label ' + lvl;
    labelEl.textContent = a.risk_level + ' Risk';

    // Summary
    document.getElementById('riskSummary').textContent = a.summary || '';

    // Gauge
    animateGauge(a.risk_score || 0, lvl);

    // Risk factors
    const rfHTML = (a.risk_factors || []).map(rf => `
        <div class="risk-factor">
            <div class="rf-header">
                <span class="rf-title">${escHtml(rf.factor)}</span>
                <span class="rf-severity ${rf.severity}">${rf.severity}</span>
            </div>
            <div class="rf-detail">${escHtml(rf.detail)}</div>
        </div>
    `).join('');
    document.getElementById('riskFactors').innerHTML = rfHTML || '<p style="color:var(--text-gray)">No specific risk factors identified.</p>';

    // Recommendations
    const recHTML = (a.recommendations || []).map(r => {
        const cat = r.category || 'lifestyle';
        const iconClass = recIcons[cat] || 'fas fa-lightbulb';
        return `
            <div class="rec-item">
                <div class="rec-icon ${cat}"><i class="${iconClass}"></i></div>
                <div>
                    <div class="rec-title">${escHtml(r.title)}</div>
                    <div class="rec-desc">${escHtml(r.description)}</div>
                </div>
            </div>
        `;
    }).join('');
    document.getElementById('recommendations').innerHTML = recHTML || '<p style="color:var(--text-gray)">No recommendations at this time.</p>';

    // Positive factors
    const posHTML = (a.positive_factors || []).map(p =>
        `<div class="positive-item"><i class="fas fa-check-circle"></i>${escHtml(p)}</div>`
    ).join('');
    document.getElementById('positiveFactors').innerHTML = posHTML || '<p style="color:var(--text-gray)">Start tracking your health to see positive patterns!</p>';

    // Suggested actions
    const actHTML = (a.suggested_actions || []).map(act => {
        const href = act.link || '/dashboard';
        const iconClass = actionIcons[href] || 'fas fa-arrow-right';
        return `
            <a href="${href}" class="action-btn">
                <i class="${iconClass}"></i>
                <span>${escHtml(act.action)}</span>
                <i class="fas fa-chevron-right arrow"></i>
            </a>
        `;
    }).join('');
    document.getElementById('suggestedActions').innerHTML = actHTML || '';

    // Show results
    document.getElementById('results').style.display = 'block';
    document.getElementById('btnRerun').style.display = 'inline-flex';
}

function escHtml(str) {
    const d = document.createElement('div');
    d.textContent = str || '';
    return d.innerHTML;
}

/* ---- Main analysis runner ---- */
async function runAnalysis() {
    const scanState = document.getElementById('scanState');
    const errorState = document.getElementById('errorState');
    const results = document.getElementById('results');

    scanState.style.display = 'block';
    errorState.style.display = 'none';
    results.style.display = 'none';
    document.getElementById('btnRerun').style.display = 'none';

    advanceStep(1);
    await sleep(600);
    advanceStep(2);
    await sleep(500);
    advanceStep(3);
    await sleep(400);
    advanceStep(4);

    try {
        const resp = await fetch('/api/analyze-health', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
        });
        const data = await resp.json();

        if (data.success) {
            // Mark all steps done
            for (let i = 1; i <= 4; i++) advanceStep(5);
            await sleep(400);
            scanState.style.display = 'none';
            renderResults(data);
        } else {
            scanState.style.display = 'none';
            errorState.style.display = 'block';
            document.getElementById('errorMsg').textContent = data.message || 'Analysis failed.';
        }
    } catch (err) {
        console.error('Analysis error:', err);
        scanState.style.display = 'none';
        errorState.style.display = 'block';
        document.getElementById('errorMsg').textContent = 'Network error. Please check your connection.';
    }
}

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

// Auto-run on page load
runAnalysis();
</script>
</body>
</html>
