<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Advanced Medical Chatbot</title>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
	<style>
		* { margin: 0; padding: 0; box-sizing: border-box; }
		:root {
			--bg: #f4f5f7;
			--surface: #ffffff;
			--surface-soft: #f8f9fa;
			--text: #111827;
			--muted: #6b7280;
			--border: #e5e7eb;
			--accent: #111827;
			--accent-soft: rgba(17, 24, 39, 0.08);
			--shadow: rgba(0, 0, 0, 0.06);
			--chip: #f3f4f6;
			--green: #22c55e;
			--red-soft: #fef2f2;
			--red-border: #fecaca;
			--red-text: #991b1b;
		}

		[data-theme="dark"] {
			--bg: #0b0b0c;
			--surface: #141414;
			--surface-soft: #1b1b1b;
			--text: #e5e7eb;
			--muted: #9ca3af;
			--border: #2a2a2a;
			--accent: #e5e7eb;
			--accent-soft: rgba(229, 231, 235, 0.12);
			--shadow: rgba(0, 0, 0, 0.3);
			--chip: #1f1f1f;
			--red-soft: #1c1111;
			--red-border: #442222;
			--red-text: #fca5a5;
		}

		body {
			font-family: 'Inter', sans-serif;
			background: var(--bg);
			color: var(--text);
			height: 100vh;
			overflow: hidden;
		}

		.app {
			display: flex;
			flex-direction: column;
			height: 100vh;
		}

		/* ── Topbar ── */
		.topbar {
			display: flex;
			align-items: center;
			justify-content: space-between;
			padding: 0.9rem 1.75rem;
			background: var(--surface);
			border-bottom: 1px solid var(--border);
			flex-shrink: 0;
		}

		.brand {
			display: flex;
			align-items: center;
			gap: 0.75rem;
		}

		.brand-icon {
			width: 38px;
			height: 38px;
			border-radius: 10px;
			background: var(--accent);
			color: var(--bg);
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 16px;
		}

		.brand h1 {
			font-size: 1.1rem;
			font-weight: 700;
			letter-spacing: -0.02em;
		}

		.brand p {
			font-size: 0.78rem;
			color: var(--muted);
			margin-top: 1px;
		}

		.topbar-actions {
			display: flex;
			gap: 0.5rem;
			align-items: center;
		}

		.icon-btn {
			width: 36px;
			height: 36px;
			border-radius: 8px;
			border: 1px solid var(--border);
			background: var(--surface-soft);
			color: var(--text);
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 14px;
			transition: all 0.15s;
		}

		.icon-btn:hover { background: var(--chip); }

		.primary-link {
			padding: 0.5rem 0.9rem;
			border-radius: 8px;
			border: 1px solid var(--border);
			text-decoration: none;
			color: var(--text);
			background: var(--surface-soft);
			font-weight: 600;
			font-size: 0.82rem;
			transition: all 0.15s;
		}

		.primary-link:hover { background: var(--chip); }

		/* ── 3-Column Layout ── */
		.layout {
			display: grid;
			grid-template-columns: 260px minmax(0, 1fr) 260px;
			gap: 0;
			flex: 1;
			min-height: 0;
		}

		/* ── Left Sidebar ── */
		.sidebar-left {
			background: var(--surface);
			border-right: 1px solid var(--border);
			display: flex;
			flex-direction: column;
			overflow: hidden;
		}

		.sidebar-section {
			padding: 0.9rem 1rem;
			border-bottom: 1px solid var(--border);
			flex-shrink: 0;
		}

		.sidebar-section-label {
			font-size: 0.68rem;
			font-weight: 700;
			text-transform: uppercase;
			letter-spacing: 0.06em;
			color: var(--muted);
			margin-bottom: 0.6rem;
		}

		.search-box {
			width: 100%;
			padding: 0.55rem 0.75rem;
			border: 1px solid var(--border);
			border-radius: 8px;
			background: var(--surface-soft);
			color: var(--text);
			font-size: 0.82rem;
			outline: none;
			transition: border 0.15s;
		}

		.search-box:focus { border-color: var(--muted); }

		.topic-scroll {
			flex: 1;
			overflow-y: auto;
			padding: 0.5rem 0.75rem 1rem;
		}

		.topic-scroll::-webkit-scrollbar { width: 4px; }
		.topic-scroll::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

		.topic-group-label {
			font-size: 0.68rem;
			font-weight: 700;
			text-transform: uppercase;
			letter-spacing: 0.05em;
			color: var(--muted);
			padding: 0.7rem 0.25rem 0.35rem;
		}

		.topic-btn {
			display: flex;
			align-items: center;
			gap: 0.55rem;
			width: 100%;
			padding: 0.55rem 0.65rem;
			border-radius: 8px;
			border: none;
			background: transparent;
			color: var(--text);
			cursor: pointer;
			text-align: left;
			font-size: 0.82rem;
			font-weight: 500;
			transition: all 0.12s;
		}

		.topic-btn i {
			font-size: 13px;
			width: 18px;
			text-align: center;
			color: var(--muted);
			flex-shrink: 0;
		}

		.topic-btn:hover { background: var(--chip); }

		/* ── Center Chat ── */
		.chat-center {
			display: flex;
			flex-direction: column;
			min-height: 0;
			background: var(--bg);
		}

		.chat-header {
			display: flex;
			align-items: center;
			justify-content: space-between;
			padding: 0.7rem 1.25rem;
			background: var(--surface);
			border-bottom: 1px solid var(--border);
			flex-shrink: 0;
		}

		.chat-header .status {
			display: flex;
			align-items: center;
			gap: 0.5rem;
			font-weight: 600;
			font-size: 0.88rem;
		}

		.status-dot {
			width: 8px;
			height: 8px;
			border-radius: 50%;
			background: var(--green);
			box-shadow: 0 0 6px rgba(34, 197, 94, 0.4);
		}

		.mode-toggles {
			display: flex;
			gap: 0.6rem;
			align-items: center;
			font-size: 0.78rem;
			color: var(--muted);
		}

		.mode-toggles label {
			display: flex;
			align-items: center;
			gap: 0.3rem;
			cursor: pointer;
		}

		.mode-toggles input { cursor: pointer; }

		.chat-window {
			flex: 1;
			overflow-y: auto;
			padding: 1.25rem 1.5rem;
			display: flex;
			flex-direction: column;
			gap: 0.6rem;
		}

		.chat-window::-webkit-scrollbar { width: 5px; }
		.chat-window::-webkit-scrollbar-thumb { background: var(--border); border-radius: 5px; }

		.message {
			display: flex;
		}

		.message.user { justify-content: flex-end; }

		.bubble {
			max-width: 72%;
			padding: 0.7rem 1rem;
			border-radius: 14px;
			line-height: 1.55;
			font-size: 0.88rem;
		}

		.message.bot .bubble {
			background: var(--surface);
			border: 1px solid var(--border);
			color: var(--text);
			border-bottom-left-radius: 4px;
		}

		.message.user .bubble {
			background: #1f1f1f;
			color: #ffffff;
			border-bottom-right-radius: 4px;
		}

		.typing {
			display: none;
			align-items: center;
			gap: 0.4rem;
			color: var(--muted);
			font-size: 0.82rem;
			padding: 0 1.5rem 0.5rem;
			flex-shrink: 0;
		}

		.typing.active { display: flex; }

		.dot {
			width: 5px;
			height: 5px;
			border-radius: 50%;
			background: var(--muted);
			animation: bounce 1s infinite ease-in-out;
		}

		.dot:nth-child(2) { animation-delay: 0.15s; }
		.dot:nth-child(3) { animation-delay: 0.3s; }

		@keyframes bounce {
			0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
			40% { transform: scale(1.3); opacity: 1; }
		}

		.quick-chips {
			display: flex;
			flex-wrap: wrap;
			gap: 0.4rem;
			padding: 0.6rem 1.25rem;
			border-top: 1px solid var(--border);
			background: var(--surface);
			flex-shrink: 0;
		}

		.chip {
			background: var(--chip);
			border: 1px solid var(--border);
			color: var(--text);
			padding: 0.35rem 0.65rem;
			border-radius: 999px;
			font-size: 0.75rem;
			cursor: pointer;
			transition: all 0.12s;
			font-weight: 500;
		}

		.chip:hover { background: var(--accent-soft); }

		.chat-input-bar {
			display: flex;
			gap: 0.6rem;
			align-items: center;
			padding: 0.75rem 1.25rem;
			background: var(--surface);
			border-top: 1px solid var(--border);
			flex-shrink: 0;
		}

		.chat-input-bar input {
			flex: 1;
			border: 1px solid var(--border);
			border-radius: 10px;
			padding: 0.65rem 0.9rem;
			background: var(--surface-soft);
			color: var(--text);
			font-size: 0.88rem;
			outline: none;
			transition: border 0.15s;
		}

		.chat-input-bar input:focus { border-color: var(--muted); }

		.send-btn {
			width: 40px;
			height: 40px;
			border-radius: 10px;
			border: none;
			background: #1f1f1f;
			color: #ffffff;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 14px;
			transition: opacity 0.15s;
			flex-shrink: 0;
		}

		.send-btn:hover { opacity: 0.85; }

		/* ── Right Sidebar ── */
		.sidebar-right {
			background: var(--surface);
			border-left: 1px solid var(--border);
			display: flex;
			flex-direction: column;
			overflow-y: auto;
			padding: 1rem;
			gap: 0.75rem;
		}

		.sidebar-right::-webkit-scrollbar { width: 4px; }
		.sidebar-right::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

		.right-card {
			background: var(--surface-soft);
			border: 1px solid var(--border);
			border-radius: 10px;
			padding: 0.85rem;
		}

		.right-card-title {
			font-size: 0.72rem;
			font-weight: 700;
			text-transform: uppercase;
			letter-spacing: 0.05em;
			color: var(--muted);
			margin-bottom: 0.55rem;
		}

		.tool-btn-row {
			display: flex;
			gap: 0.4rem;
		}

		.tool-btn {
			flex: 1;
			padding: 0.5rem 0.5rem;
			border-radius: 8px;
			border: 1px solid var(--border);
			background: var(--surface);
			color: var(--text);
			cursor: pointer;
			font-size: 0.78rem;
			font-weight: 600;
			text-align: center;
			transition: all 0.12s;
			text-decoration: none;
			display: block;
		}

		.tool-btn:hover { background: var(--chip); }

		.tool-btn i { margin-right: 4px; font-size: 11px; }

		.stats-grid {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 0.4rem;
		}

		.stat-item {
			background: var(--surface);
			border: 1px solid var(--border);
			border-radius: 8px;
			padding: 0.6rem;
			text-align: center;
		}

		.stat-number {
			font-size: 1.3rem;
			font-weight: 700;
			display: block;
		}

		.stat-label {
			font-size: 0.7rem;
			color: var(--muted);
			margin-top: 2px;
		}

		.emergency-card {
			background: var(--red-soft);
			border: 1px solid var(--red-border);
			border-radius: 10px;
			padding: 0.85rem;
		}

		.emergency-card .right-card-title {
			color: var(--red-text);
		}

		.emergency-card p {
			font-size: 0.8rem;
			color: var(--red-text);
			line-height: 1.45;
		}

		.keyboard-hint {
			font-size: 0.72rem;
			color: var(--muted);
			text-align: center;
			padding-top: 0.4rem;
		}

		.keyboard-hint kbd {
			background: var(--surface);
			border: 1px solid var(--border);
			border-radius: 4px;
			padding: 1px 5px;
			font-family: inherit;
			font-size: 0.7rem;
		}

		/* ── Responsive ── */
		@media (max-width: 1100px) {
			.layout { grid-template-columns: 1fr; }
			.sidebar-left, .sidebar-right { display: none; }
			body { overflow: auto; }
			.app { height: auto; min-height: 100vh; }
			.chat-center { min-height: 100vh; }
			.chat-window { min-height: 50vh; }
		}
	</style>
</head>
<body>
	<div class="app">
		<header class="topbar">
			<div class="brand">
				<div class="brand-icon"><i class="fas fa-stethoscope"></i></div>
				<div>
					<h1>Medical Chatbot</h1>
					<p>173 topics — symptoms, diseases, clinical, wellness</p>
				</div>
			</div>
			<div class="topbar-actions">
				<button id="theme-toggle" class="icon-btn" title="Toggle theme"><i class="fas fa-moon"></i></button>
				<a class="primary-link" href="/dashboard"><i class="fas fa-arrow-left"></i> Dashboard</a>
			</div>
		</header>

		<div class="layout">
			<!-- Left Sidebar: Topics -->
			<aside class="sidebar-left">
				<div class="sidebar-section">
					<div class="sidebar-section-label">Search Topics</div>
					<input id="topic-search" class="search-box" type="text" placeholder="Type to filter...">
				</div>
				<div class="topic-scroll" id="topic-list">
					<div class="topic-group-label">Body Systems</div>
					<button class="topic-btn" data-prompt="How does the heart work?"><i class="fas fa-heartbeat"></i> Heart & Circulation</button>
					<button class="topic-btn" data-prompt="How do the lungs work?"><i class="fas fa-lungs"></i> Lungs & Breathing</button>
					<button class="topic-btn" data-prompt="How does the brain work?"><i class="fas fa-brain"></i> Brain & Nerves</button>
					<button class="topic-btn" data-prompt="Explain digestion and gut health."><i class="fas fa-stomach"></i> Digestive System</button>
					<button class="topic-btn" data-prompt="Explain the immune system."><i class="fas fa-shield-virus"></i> Immune System</button>
					<button class="topic-btn" data-prompt="How do the kidneys work?"><i class="fas fa-kidney"></i> Kidneys</button>
					<button class="topic-btn" data-prompt="Tell me about bones and the skeletal system."><i class="fas fa-bone"></i> Bones & Skeleton</button>
					<button class="topic-btn" data-prompt="How do muscles work?"><i class="fas fa-dumbbell"></i> Muscles</button>

					<div class="topic-group-label">Common Symptoms</div>
					<button class="topic-btn" data-prompt="What causes fever and how to treat it?"><i class="fas fa-thermometer-half"></i> Fever</button>
					<button class="topic-btn" data-prompt="What causes headaches?"><i class="fas fa-head-side-virus"></i> Headache</button>
					<button class="topic-btn" data-prompt="What causes cough?"><i class="fas fa-lungs-virus"></i> Cough</button>
					<button class="topic-btn" data-prompt="I have stomach pain, what could it be?"><i class="fas fa-stomach"></i> Stomach Pain</button>
					<button class="topic-btn" data-prompt="What causes back pain?"><i class="fas fa-back"></i> Back Pain</button>
					<button class="topic-btn" data-prompt="I feel dizzy and lightheaded"><i class="fas fa-dizzy"></i> Dizziness</button>
					<button class="topic-btn" data-prompt="I feel very tired and fatigued"><i class="fas fa-battery-quarter"></i> Fatigue</button>

					<div class="topic-group-label">Diseases & Conditions</div>
					<button class="topic-btn" data-prompt="What is diabetes and how to manage it?"><i class="fas fa-tint"></i> Diabetes</button>
					<button class="topic-btn" data-prompt="Explain blood pressure and hypertension."><i class="fas fa-heart-circle-exclamation"></i> Hypertension</button>
					<button class="topic-btn" data-prompt="Explain asthma symptoms and management."><i class="fas fa-wind"></i> Asthma</button>
					<button class="topic-btn" data-prompt="Tell me about heart disease"><i class="fas fa-heart-crack"></i> Heart Disease</button>
					<button class="topic-btn" data-prompt="What is thyroid disease?"><i class="fas fa-disease"></i> Thyroid</button>
					<button class="topic-btn" data-prompt="Tell me about allergies"><i class="fas fa-allergies"></i> Allergies</button>
					<button class="topic-btn" data-prompt="What is COVID-19?"><i class="fas fa-virus"></i> COVID-19</button>

					<div class="topic-group-label">Mental Health</div>
					<button class="topic-btn" data-prompt="Tell me about stress and anxiety"><i class="fas fa-cloud-rain"></i> Stress & Anxiety</button>
					<button class="topic-btn" data-prompt="What is depression?"><i class="fas fa-sad-tear"></i> Depression</button>
					<button class="topic-btn" data-prompt="What is PTSD?"><i class="fas fa-bolt"></i> PTSD</button>
					<button class="topic-btn" data-prompt="What is ADHD?"><i class="fas fa-lightbulb"></i> ADHD</button>

					<div class="topic-group-label">Wellness & Prevention</div>
					<button class="topic-btn" data-prompt="Tell me about vitamins and minerals."><i class="fas fa-apple-whole"></i> Nutrition</button>
					<button class="topic-btn" data-prompt="Tips for better sleep"><i class="fas fa-moon"></i> Sleep</button>
					<button class="topic-btn" data-prompt="Benefits of exercise"><i class="fas fa-person-running"></i> Exercise</button>
					<button class="topic-btn" data-prompt="How to stay healthy?"><i class="fas fa-spa"></i> Healthy Lifestyle</button>
					<button class="topic-btn" data-prompt="Tell me about vaccines"><i class="fas fa-syringe"></i> Vaccines</button>
					<button class="topic-btn" data-prompt="Recommended health screenings"><i class="fas fa-clipboard-check"></i> Screenings</button>

					<div class="topic-group-label">First Aid & Emergency</div>
					<button class="topic-btn" data-prompt="How to do CPR?"><i class="fas fa-hand-holding-medical"></i> CPR</button>
					<button class="topic-btn" data-prompt="First aid for burns"><i class="fas fa-fire"></i> Burns</button>
					<button class="topic-btn" data-prompt="What to do if someone is choking?"><i class="fas fa-circle-exclamation"></i> Choking</button>
					<button class="topic-btn" data-prompt="What are signs of a stroke?"><i class="fas fa-triangle-exclamation"></i> Stroke Signs</button>

					<div class="topic-group-label">Clinical & Patient Info</div>
					<button class="topic-btn" data-prompt="What are normal vital signs?"><i class="fas fa-chart-line"></i> Vital Signs</button>
					<button class="topic-btn" data-prompt="What blood tests should I know about?"><i class="fas fa-vial"></i> Blood Tests</button>
					<button class="topic-btn" data-prompt="Explain different types of medical imaging"><i class="fas fa-x-ray"></i> Imaging (MRI, CT)</button>
					<button class="topic-btn" data-prompt="What are my rights as a patient?"><i class="fas fa-scale-balanced"></i> Patient Rights</button>
					<button class="topic-btn" data-prompt="What happens during a hospital stay?"><i class="fas fa-hospital"></i> Hospital Stay</button>
					<button class="topic-btn" data-prompt="Should I go to ER or urgent care?"><i class="fas fa-truck-medical"></i> ER vs Urgent Care</button>
				</div>
			</aside>

			<!-- Center: Chat -->
			<main class="chat-center">
				<div class="chat-header">
					<div class="status">
						<span class="status-dot"></span>
						Medical Assistant — Online
					</div>
					<div class="mode-toggles">
						<label><input type="checkbox" id="mode-detailed"> Detailed</label>
						<label><input type="checkbox" id="mode-bullets"> Bullets</label>
						<label><input type="checkbox" id="mode-followup"> Follow-up</label>
					</div>
				</div>

				<div class="chat-window" id="chat-window">
					<div class="message bot">
						<div class="bubble">Hello! I can help with symptoms, diseases, body systems, medications, nutrition, mental health, first aid, and clinical questions. Ask anything in your own words.</div>
					</div>
				</div>

				<div class="typing" id="typing-indicator">
					<span>Typing</span>
					<span class="dot"></span><span class="dot"></span><span class="dot"></span>
				</div>

				<div class="quick-chips">
					<button class="chip" data-prompt="What does chest pain mean?"><i class="fas fa-heart-pulse" style="font-size:10px"></i> Chest pain</button>
					<button class="chip" data-prompt="How to lower fever?"><i class="fas fa-thermometer" style="font-size:10px"></i> Fever</button>
					<button class="chip" data-prompt="Tell me about stress and anxiety"><i class="fas fa-cloud" style="font-size:10px"></i> Stress</button>
					<button class="chip" data-prompt="How to build a healthy diet?"><i class="fas fa-carrot" style="font-size:10px"></i> Diet</button>
					<button class="chip" data-prompt="What causes cough?"><i class="fas fa-lungs" style="font-size:10px"></i> Cough</button>
					<button class="chip" data-prompt="How much water should I drink?"><i class="fas fa-glass-water" style="font-size:10px"></i> Hydration</button>
					<button class="chip" data-prompt="I am not feeling well"><i class="fas fa-face-frown" style="font-size:10px"></i> Feeling sick</button>
					<button class="chip" data-prompt="When should I see a doctor?"><i class="fas fa-user-doctor" style="font-size:10px"></i> See a doctor?</button>
				</div>

				<div class="chat-input-bar">
					<input id="chat-input" type="text" placeholder="Ask a health question..." autocomplete="off" />
					<button class="send-btn" id="send-btn"><i class="fas fa-arrow-up"></i></button>
				</div>
			</main>

			<!-- Right Sidebar: Tools & Stats -->
			<aside class="sidebar-right">
				<div class="right-card">
					<div class="right-card-title">Session Tools</div>
					<div class="tool-btn-row">
						<button class="tool-btn" id="clear-chat"><i class="fas fa-trash-can"></i> Clear</button>
						<button class="tool-btn" id="export-chat"><i class="fas fa-download"></i> Export</button>
						<button class="tool-btn" id="copy-chat"><i class="fas fa-copy"></i> Copy</button>
					</div>
				</div>

				<div class="right-card">
					<div class="right-card-title">Conversation Stats</div>
					<div class="stats-grid">
						<div class="stat-item">
							<span class="stat-number" id="stat-messages">1</span>
							<div class="stat-label">Messages</div>
						</div>
						<div class="stat-item">
							<span class="stat-number" id="stat-topics">0</span>
							<div class="stat-label">Topics</div>
						</div>
					</div>
				</div>

				<div class="right-card">
					<div class="right-card-title">Quick Navigation</div>
					<div style="display:grid;gap:0.35rem;">
						<a class="tool-btn" href="/dashboard"><i class="fas fa-gauge"></i> Dashboard</a>
					</div>
				</div>

				<div class="right-card">
					<div class="right-card-title">How to use</div>
					<p style="font-size:0.8rem;color:var(--muted);line-height:1.5;">
						Type any health question or click a topic on the left. Use quick chips below the chat for common queries. Toggle Detailed/Bullets modes above the chat.
					</p>
				</div>

				<div class="emergency-card">
					<div class="right-card-title"><i class="fas fa-triangle-exclamation"></i> Emergency</div>
					<p>Severe chest pain, difficulty breathing, stroke signs, or uncontrolled bleeding — call emergency services immediately.</p>
				</div>

				<div class="keyboard-hint">
					Press <kbd>Enter</kbd> to send — <kbd>/</kbd> to focus input
				</div>
			</aside>
		</div>
	</div>

	<script>
		const rootEl = document.documentElement;
		const themeToggleBtn = document.getElementById('theme-toggle');
		const chatWindow = document.getElementById('chat-window');
		const chatInput = document.getElementById('chat-input');
		const sendBtn = document.getElementById('send-btn');
		const typingIndicator = document.getElementById('typing-indicator');
		const statMessages = document.getElementById('stat-messages');
		const statTopics = document.getElementById('stat-topics');
		const topicSearch = document.getElementById('topic-search');
		const topicList = document.getElementById('topic-list');

		const messages = [{ role: 'bot', text: 'Hello! I can help with symptoms, diseases, body systems, medications, nutrition, mental health, first aid, and clinical questions. Ask anything in your own words.' }];

		function applyTheme(theme) {
			rootEl.setAttribute('data-theme', theme);
			localStorage.setItem('mk-theme', theme);
			themeToggleBtn.innerHTML = theme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
		}

		function initTheme() {
			const saved = localStorage.getItem('mk-theme');
			applyTheme(saved || 'light');
		}

		function escapeHtml(text) {
			const div = document.createElement('div');
			div.textContent = text;
			return div.innerHTML;
		}

		function addMessage(role, text) {
			const wrapper = document.createElement('div');
			wrapper.className = `message ${role}`;
			const bubble = document.createElement('div');
			bubble.className = 'bubble';
			bubble.innerHTML = escapeHtml(text).replace(/\n/g, '<br>');
			wrapper.appendChild(bubble);
			chatWindow.appendChild(wrapper);
			chatWindow.scrollTop = chatWindow.scrollHeight;
			messages.push({ role, text });
			statMessages.textContent = messages.length;
		}

		function buildPrompt(raw) {
			let prompt = raw.trim();
			if (!prompt) return '';

			const detailed = document.getElementById('mode-detailed').checked;
			const bullets = document.getElementById('mode-bullets').checked;
			const followup = document.getElementById('mode-followup').checked;

			const hints = [];
			if (detailed) hints.push('Give a detailed answer.');
			if (bullets) hints.push('Use bullet points.');
			if (followup) hints.push('Ask one follow-up question.');

			if (hints.length) {
				prompt += `\n\n${hints.join(' ')}`;
			}
			return prompt;
		}

		async function sendMessage() {
			const raw = chatInput.value;
			const prompt = buildPrompt(raw);
			if (!prompt) return;

			addMessage('user', raw);
			chatInput.value = '';
			typingIndicator.classList.add('active');

			try {
				const response = await fetch('/api/chat', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ message: prompt })
				});
				const data = await response.json();
				addMessage('bot', data.reply || 'Sorry, I had trouble answering that.');
			} catch (error) {
				addMessage('bot', 'Sorry, I could not reach the server. Please try again.');
			} finally {
				typingIndicator.classList.remove('active');
			}
		}

		function exportChat() {
			const content = messages.map(m => `${m.role.toUpperCase()}: ${m.text}`).join('\n\n');
			const blob = new Blob([content], { type: 'text/plain' });
			const url = URL.createObjectURL(blob);
			const a = document.createElement('a');
			a.href = url;
			a.download = 'chat-transcript.txt';
			a.click();
			URL.revokeObjectURL(url);
		}

		function copyLatestReply() {
			const lastBot = [...messages].reverse().find(m => m.role === 'bot');
			if (!lastBot) return;
			navigator.clipboard.writeText(lastBot.text);
		}

		function clearChat() {
			chatWindow.innerHTML = '';
			messages.length = 0;
			addMessage('bot', 'Chat cleared. Ask a new health question anytime.');
		}

		function bindPromptButtons(selector, increment = false) {
			document.querySelectorAll(selector).forEach(btn => {
				btn.addEventListener('click', () => {
					const prompt = btn.getAttribute('data-prompt');
					if (!prompt) return;
					if (increment) {
						const current = Number(statTopics.textContent || '0');
						statTopics.textContent = current + 1;
					}
					chatInput.value = prompt;
					chatInput.focus();
				});
			});
		}

		function filterTopics(value) {
			const query = value.toLowerCase();
			topicList.querySelectorAll('.topic-btn').forEach(btn => {
				const text = btn.textContent.toLowerCase();
				btn.style.display = text.includes(query) ? '' : 'none';
			});
			topicList.querySelectorAll('.topic-group-label').forEach(label => {
				const next = [];
				let el = label.nextElementSibling;
				while (el && !el.classList.contains('topic-group-label')) {
					if (el.classList.contains('topic-btn')) next.push(el);
					el = el.nextElementSibling;
				}
				const anyVisible = next.some(b => b.style.display !== 'none');
				label.style.display = anyVisible ? '' : 'none';
			});
		}

		// Keyboard shortcut: / to focus input
		document.addEventListener('keydown', (e) => {
			if (e.key === '/' && document.activeElement !== chatInput && document.activeElement !== topicSearch) {
				e.preventDefault();
				chatInput.focus();
			}
		});

		sendBtn.addEventListener('click', sendMessage);
		chatInput.addEventListener('keypress', (e) => {
			if (e.key === 'Enter') sendMessage();
		});
		document.getElementById('export-chat').addEventListener('click', exportChat);
		document.getElementById('copy-chat').addEventListener('click', copyLatestReply);
		document.getElementById('clear-chat').addEventListener('click', clearChat);
		themeToggleBtn.addEventListener('click', () => {
			const current = rootEl.getAttribute('data-theme') || 'light';
			applyTheme(current === 'dark' ? 'light' : 'dark');
		});

		topicSearch.addEventListener('input', (e) => filterTopics(e.target.value));

		bindPromptButtons('.chip');
		bindPromptButtons('.topic-btn', true);

		initTheme();
	</script>
</body>
</html>
